#!/bin/bash
set -e

# ============================
# MehTunnel v5 Auto Installer
# ============================

# ØªÙ†Ø¸ÛŒÙ… Ù¾ÙˆØ±Øªâ€ŒÙ‡Ø§
BRIDGE_PORT=5555
SYNC_PORT=5556
MANUAL_PORTS="443,2090"

# Ù…Ø³ÛŒØ± Ù†ØµØ¨
INSTALL_PATH="/root"
SCRIPT_NAME="mehtunnel.py"
SERVICE_NAME="mehtunnel.service"

# Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ø¯ Python
echo "ðŸ”¹ Ø¯Ø§Ù†Ù„ÙˆØ¯ MehTunnel v5..."
wget -O $INSTALL_PATH/$SCRIPT_NAME "https://raw.githubusercontent.com/your-repo/MehTunnel-v5/main/mehtunnel.py"

# Detect mode
read -p "Ø³Ø±ÙˆØ± Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø³ØªØŸ (iran/eu): " MODE
MODE=$(echo $MODE | tr '[:upper:]' '[:lower:]')

if [ "$MODE" == "iran" ]; then
    RUN_MODE="IRAN"
    ENV_FILE="BRIDGE_PORT=$BRIDGE_PORT
SYNC_PORT=$SYNC_PORT
MANUAL_PORTS=$MANUAL_PORTS
RUN_MODE=$RUN_MODE"
elif [ "$MODE" == "eu" ]; then
    RUN_MODE="EUROPE"
    read -p "Ø¢ÛŒâ€ŒÙ¾ÛŒ Ø³Ø±ÙˆØ± Ø§ÛŒØ±Ø§Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯: " IRAN_IP
    ENV_FILE="BRIDGE_PORT=$BRIDGE_PORT
SYNC_PORT=$SYNC_PORT
IRAN_IP=$IRAN_IP
RUN_MODE=$RUN_MODE"
else
    echo "âŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø§Ù…Ø¹ØªØ¨Ø±!"
    exit 1
fi

# Ø§ÛŒØ¬Ø§Ø¯ systemd service
echo "ðŸ”¹ Ø§ÛŒØ¬Ø§Ø¯ systemd service..."
cat > /etc/systemd/system/$SERVICE_NAME <<EOL
[Unit]
Description=MehTunnel v5 - $RUN_MODE Node
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=$INSTALL_PATH
Environment="$ENV_FILE"
ExecStart=/usr/bin/python3 $INSTALL_PATH/$SCRIPT_NAME
Restart=always
RestartSec=3
LimitNOFILE=1000000

[Install]
WantedBy=multi-user.target
EOL

# Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ systemd
echo "ðŸ”¹ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ systemd..."
sudo systemctl daemon-reload
sudo systemctl enable $SERVICE_NAME
sudo systemctl start $SERVICE_NAME

echo "âœ… MehTunnel v5 Ù†ØµØ¨ Ùˆ Ø§Ø¬Ø±Ø§ Ø´Ø¯!"
echo "Bridge Port: $BRIDGE_PORT, Sync Port: $SYNC_PORT"
echo "Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„Ø§Ú¯: sudo journalctl -u $SERVICE_NAME -f"
